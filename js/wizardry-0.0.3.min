// Wizardry jQuery Plugin, v0.0.3, Copyright (c) 2017 Peter Wood (see LICENSE file).
$.fn.wizardry=function(e){var t={autoApplyHandlers:function(e,t){var o;o=t.find(".wizardry-next-control"),o.length>0&&(console.log("Auto-applying next control event handlers."),o.click(function(t){e.target.trigger(jQuery.Event("wizardry.forward",{state:e.state}))})),o=t.find(".wizardry-previous-control"),o.length>0&&(console.log("Auto-applying previous control event handlers."),o.click(function(t){e.target.trigger(jQuery.Event("wizardry.backward",{state:e.state}))})),o=t.find(".wizardry-restart-control"),o.length>0&&(console.log("Auto-applying restart control event handlers."),o.click(function(t){e.target.trigger(jQuery.Event("wizardry.restart",{state:e.state}))}))},backward:function(e){if(console.log("Previous step regression requested, checking if a step is available. Progression:",e.progression),e.progression.length>0){var o=e.progression.pop();console.log("Rewinding to step offset "+o+"."),t.gotoOffset(e,o)}else console.log("No previous step available, doing nothing.")},currentStep:function(e){return t.getStep(e,e.offset)},getStep:function(e,t){if(0>t||t>=e.configuration.length)throw"Request for step details specified an invalid offset of "+t+".";return e.configuration[t]},fetchTemplate:function(e){var o,n=t.currentStep(e);if(!n.ui)throw"No user interface configuration specified for step offset "+e.offset+".";if(n.ui.template){if(!n.ui.template.selector)throw"Invalid template user interface configuration for step offset "+e.offset+".";o=t.getTemplate(n.ui.template.selector)}else{if(!n.ui.url)throw"Invalid or incomplete user interface configuration for step offset "+e.offset+".";o=t.loadTemplate(n.ui.url,n.ui.method||"GET")}return o},forward:function(e){var o=t.currentStep(e),n=!0;if(console.log("Next step progression requested. Starting offset is "+e.offset+"."),o.onExit&&(console.log("Step has progression validator, calling it."),n=o.onExit(e.state,r,o)===!0),n){var i=e.offset,s=!0;if(console.log("Progression to next step permitted, checking if a step is available."),o.getNextStepId){var a=o.getNextStepId(state);if(!a||!t.idExists(e,a))throw"Invalid step id '"+a+"' returned by getNextStepId() call for step offset "+e.offset;console.log("Progressing to step id '"+a+"'."),t.gotoId(e,a),s=!0}else newOffset=e.offset+1,t.isValidOffset(e,newOffset)?(t.gotoOffset(e,newOffset),s=!0):console.log("Unable to move forward as there are no further steps.");console.log("Checking if we actually progressed a step."),s&&(0===e.progression.length||e.progression[e.progression.length-1]!==i)&&(console.log("Pushing step offset "+i+" on to the progression list."),e.progression.push(i))}else console.log("Progression to next step not permitted as onExit() did not return true.")},getTemplate:function(e){var t=$("#"+e);if(0===t.length)throw"Invalid template selector '"+e+"' specified for step offset "+o.offset+".";return t.html()},gotoId:function(e,o){if(!t.idExists(e,o))throw"Move to step id '"+o+"' requested but there is no step possessing that id.";t.gotoOffset(e,t.offsetForId(e,o))},gotoOffset:function(e,o){var n;if(console.log("Request to move to step offset "+o+" received."),!t.isValidOffset(e,o))throw"Request received to proceed to the invalid offset "+o+".";n=t.getStep(e,o),e.offset=o,n.onEnter&&n.onEnter(e.state,n),t.showUI(e)},idExists:function(e,t){return-1!==e.configuration.findIndex(function(e){e.id===t})},isValidOffset:function(e,t){return t>=0&&t<e.configuration.length},loadTemplate:function(e,t){var o,n=function(t,n,r){console.log("Load of template from",e,"successful."),o=t},r=function(t,o,n){console.log("Load of template from",e,"failed. Status:",o,", Error:",n)},i={async:!1,dataType:"html",error:r,method:t||"GET",success:n,url:e};return console.log("Loading template from "+e+"."),jQuery.ajax(e,i),o},offsetForId:function(e,t){var o,n=e.configuration.findIndex(function(e){e.id===t});return-1!==n&&(o=n),o},renderTemplate:function(e,o){var n=t.currentStep(o),r={};return n.templateData&&(r=n.templateData(o.state)),r=jQuery.extend(r,o.state),console.log("Rendering the template with the data:",r),$(Mustache.render(e,r))},restart:function(e){e.state=e.initializeState?e.initializeState(state):{},t.gotoOffset(e,0)},showUI:function(e){var o=t.renderTemplate(t.fetchTemplate(e),e),n=t.currentStep(e);console.log("Checking if any automatic event handlers are needed."),t.autoApplyHandlers(e,o),console.log("Showing the UI for the current context step."),t.transition(e,o,n.onShow)},transition:function(e,o,n){var r=e.target.children(),i=(t.currentStep(e),function(){n&&n(e.state,o)}),s=function(){e.target.empty(),e.target.append(o),o.fadeIn("fast",i)};o.hide(),r.length>0?r.fadeOut("fast",s):s()}},o=null,n={backward:function(e){console.log("Backward event triggered for step plugin instance."),t.backward(e)},cancel:function(e){console.log("Cancel event triggered for step plugin instance."),e.configuration.events.cancel&&(console.log("Found custom cancellation handler, calling it."),e.configuration.events.cancel(e.state))},forward:function(e){console.log("Forward event triggered for step plugin."),t.forward(e)},restart:function(e){console.log("Restart event triggered for step plugin instance."),t.restart(e,e.state)}},r=$(this);if(!e||0===e.length)throw"No configuration or empty configuration specified for stepped control.";o={configuration:e,offset:0,progression:[],state:{},target:$(this)},r.on("wizardry.backward",function(){n.backward(o)}),r.on("wizardry.cancel",function(){n.cancel(o)}),r.on("wizardry.forward",function(){n.forward(o)}),r.on("wizardry.restart",function(){n.restart(o)}),t.restart(o)};