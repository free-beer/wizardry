// Wizardry jQuery Plugin, v0.0.1, Copyright (c) 2017 Peter Wood (see LICENSE file).
$.fn.wizardry=function(e){var t={autoApplyHandlers:function(e,t){var o;o=t.find(".wizardry-next-control"),o.length>0&&(console.log("Auto-applying next control event handlers."),o.click(function(t){e.target.trigger(jQuery.Event("wizardry.forward",{state:e.state}))})),o=t.find(".wizardry-previous-control"),o.length>0&&(console.log("Auto-applying previous control event handlers."),o.click(function(t){e.target.trigger(jQuery.Event("wizardry.backward",{state:e.state}))})),o=t.find(".wizardry-restart-control"),o.length>0&&(console.log("Auto-applying restart control event handlers."),o.click(function(t){e.target.trigger(jQuery.Event("wizardry.restart",{state:e.state}))}))},backward:function(e,o){if(console.log("Previous step regression requested, checking if a step is available. Progression:",e.progression),e.progression.length>0){var n=e.progression.pop();console.log("Rewinding to step offset "+n+"."),t.gotoOffset(e,e.state,n)}else console.log("No previous step available, doing nothing.")},currentStep:function(e){return t.getStep(e,e.offset)},getStep:function(e,t){if(0>t||t>=e.configuration.length)throw"Request for step details specified an invalid offset of "+t+".";return e.configuration[t]},fetchTemplate:function(e){var o,n=t.currentStep(e);if(!n.ui)throw"No user interface configuration specified for step offset "+e.offset+".";if(n.ui.template){if(!n.ui.template.selector)throw"Invalid template user interface configuration for step offset "+e.offset+".";o=t.getTemplate(n.ui.template.selector)}else{if(!n.ui.url)throw"Invalid or incomplete user interface configuration for step offset "+e.offset+".";o=t.loadTemplate(n.ui.url,n.ui.method||"GET")}return o},forward:function(e,o){var n=t.currentStep(e),s=!0;if(console.log("Next step progression requested. Starting offset is "+e.offset+"."),n.onExit&&(console.log("Step has progression validator, calling it."),s=n.onExit(r,o)===!0),s){var i=e.offset;if(console.log("Progression to next step permitted, checking if a step is available."),(0===e.progression.length||e.progression[e.progression.length-1]!==i)&&(console.log("Pushing step offset "+i+" on to the progression list."),e.progression.push(i)),n.getNextStepId){var a=n.getNextStepId(o);if(!a||!t.idExists(e,a))throw"Invalid step id '"+a+"' returned by getNextStepId() call for step offset "+e.offset;console.log("Progressing to step id '"+a+"'."),t.gotoId(e,e.state,a)}else newOffset=e.offset+1,t.isValidOffset(e,newOffset)?t.gotoOffset(e,e.state,newOffset):console.log("Unable to move forward as there are no further steps.")}else console.log("Progression to next step not permitted as onExit() did not return true.")},getTemplate:function(e){var t=$("#"+e);if(0===t.length)throw"Invalid template selector '"+step.ui.template.selector+"' specified for step offset "+o.offset+".";return t.html()},gotoId:function(e,o,n){if(!t.idExists(e,n))throw"Move to step id '"+n+"' requested but there is no step possessing that id.";t.gotoOffset(e,o,t.offsetForId(e,n))},gotoOffset:function(e,o,n){var r;if(console.log("Request to move to step offset "+n+" received."),!t.isValidOffset(e,n))throw"Request received to proceed to the invalid offset "+n+".";r=t.getStep(e,n),e.offset=n,r.onEnter&&r.onEnter(e.state),t.showUI(e,e.state)},idExists:function(e,t){return-1!==e.configuration.findIndex(function(e){e.id===t})},isValidOffset:function(e,t){return t>=0&&t<e.configuration.length},loadTemplate:function(e,t){var o,n=function(t,n,r){console.log("Load of template from",e,"successful."),o=t},r=function(t,o,n){console.log("Load of template from",e,"failed. Status:",o,", Error:",n)},s={async:!1,dataType:"html",error:r,method:t||"GET",success:n,url:e};return console.log("Loading template from "+e+"."),jQuery.ajax(e,s),o},offsetForId:function(e,t){var o,n=e.configuration.findIndex(function(e){e.id===t});return-1!==n&&(o=n),o},renderTemplate:function(e,t){return console.log("Rendering the template with the state:",t.state),$(Mustache.render(e,t.state))},restart:function(e,o){e.state=e.initializeState?e.initializeState(o):{},t.gotoOffset(e,o,0)},showUI:function(e,o){var n=t.renderTemplate(t.fetchTemplate(e),e),r=t.currentStep(e);console.log("Checking if any automatic event handlers are needed."),t.autoApplyHandlers(e,n),console.log("Showing the UI for the current context step."),t.transition(e,n,r.onShow)},transition:function(e,o,n){var r=e.target.children(),s=(t.currentStep(e),function(){n&&n(e.state,o)}),i=function(){e.target.empty(),e.target.append(o),o.fadeIn("fast",s)};o.hide(),r.length>0?r.fadeOut("fast",i):i()}},o={configuration:e,offset:0,progression:[],state:{},target:$(this)},n={backward:function(e){console.log("Backward event triggered for step plugin instance."),t.backward(o,o.state)},cancel:function(e){console.log("Cancel event triggered for step plugin instance."),o.configuration.events.cancel&&(console.log("Found custom cancellation handler, calling it."),o.configuration.events.cancel(o.state))},forward:function(e){console.log("Forward event triggered for step plugin."),t.forward(o,o.state)},restart:function(e){console.log("Restart event triggered for step plugin instance."),t.restart(o,o.state)}},r=(o.state,$(this));if(!e||0===e.length)throw"No configuration or empty configuration specified for stepped control.";r.on("wizardry.backward",n.backward),r.on("wizardry.cancel",n.cancel),r.on("wizardry.forward",n.forward),r.on("wizardry.restart",n.restart),t.restart(o,o.state)};